function Frame(e){this.bindings={};this.parent=e}function LambdaProcedure(e,t,n,r){this.formals=e;this.body=t;this.env=n;this.dotted=r}function scheme_eval(e,t){while(true){if(e===null){throw"SchemeError: Cannot evaluate an undefined expression."}if(scheme_symbolp(e)){return t.lookup(e)}else if(scheme_atomp(e)){return e}if(!scheme_listp(e)){throw"SchemeError: malformed list: "+e.toString()}var n=e.first;var r=e.second;if(n in LOGIC_FORMS){e=LOGIC_FORMS[n](r,t)}else if(n==="lambda"){return do_lambda_form(r,t)}else if(n==="set!"){return do_sete_form(r,t)}else if(n==="set-car!"){return do_set_care_form(r,t)}else if(n==="set-cdr!"){return do_set_cdre_form(r,t)}else if(n==="define"){return do_define_form(r,t)}else if(n==="quote"){return do_quote_form(r)}else if(n==="let"){var i=do_let_form(r,t);e=i[0];t=i[1]}else{var s=scheme_eval(n,t);var o=r.map(function(e){return scheme_eval(e,t)});if(s instanceof LambdaProcedure){t=s.env.make_call_frame(s.formals,o,s.dotted);e=s.body}else{return scheme_apply(s,o,t)}}}}function scheme_apply(e,t,n){if(e instanceof PrimitiveProcedure){return apply_primitive(e,t,n)}else if(e instanceof LambdaProcedure){var r=e.env.make_call_frame(e.formals,t,e.dotted);return scheme_eval(e.body,r)}else{throw"SchemeError: Cannot call "+e.toString()}}function apply_primitive(e,t,n){t=pair_to_array(t);if(e.use_env){t.push(n)}return e.fn.apply(this,t)}function num_parameters(e){var t=e.toString();var n=t.slice(t.indexOf("(")+1,t.indexOf(")"));return n.match(/,/g).length+1}function pair_to_array(e){if(e===nil){return[]}return[e.first].concat(pair_to_array(e.second))}function array_to_pair(e){if(e.length==0){return nil}else{var t=e.shift();return new Pair(t,array_to_pair(e))}}function do_lambda_form(e,t){var n,r;check_form(e,2);r=e.getitem(0);var i=check_formals(r);if(e.length==2){n=e.getitem(1)}else{n=new Pair("begin",e.second)}return new LambdaProcedure(r,n,t,i)}function do_sete_form(e,t){var n,r;check_form(e,2,2);n=e.getitem(0);r=scheme_eval(e.getitem(1),t);if(scheme_symbolp(n)){t.sete(n,r)}else{throw"SchemeError: cannot set!: "+n.toString()+" is not a variable"}}function do_set_care_form(e,t){var n,r;check_form(e,2,2);n=e.getitem(0);r=scheme_eval(e.getitem(1),t);scheme_eval(n,t).first=r}function do_set_cdre_form(e,t){var n,r;check_form(e,2,2);n=e.getitem(0);r=scheme_eval(e.getitem(1),t);scheme_eval(n,t).second=r}function do_define_form(e,t){var n,r,i,s;check_form(e,2);n=e.getitem(0);if(scheme_symbolp(n)){check_form(e,2,2);r=scheme_eval(e.getitem(1),t);t.define(n,r)}else if(n instanceof Pair){i=n.getitem(0);if(!scheme_symbolp(i)){throw"SchemeError: not a variable: "+i.toString()}s=new Pair(e.first.second,e.second);r=do_lambda_form(s,t);t.define(i,r)}else{throw"SchemeError: bad argument to define"}}function do_quote_form(e){check_form(e,1,1);return e.getitem(0)}function do_let_form(e,t){check_form(e,2);var n=e.getitem(0);var r=e.second;if(!scheme_listp(n)){throw"SchemeError: bad bindings list in let form"}var i=nil;e=nil;var s=t.make_call_frame(i,e);for(var o=0;o<n.length;o++){var u=n.getitem(o);check_form(u,2,2);if(!scheme_symbolp(u.getitem(0))){throw"SchemeError: bad binding: "+u.toString()}var a=u.getitem(0);var f=scheme_eval(u.getitem(1),t);s.define(a,f)}var l=r.length-1;for(o=0;o<l;o++){scheme_eval(r.getitem(o),s)}return[r.getitem(l),s]}function do_if_form(e,t){check_form(e,3,3);var n=scheme_eval(e.getitem(0),t);var r=e.getitem(1);var i=e.getitem(2);if(scheme_true(n)){return r}else{return i}}function do_and_form(e,t){if(e.length==0){return true}for(var n=0;n<e.length;n++){var r=scheme_eval(e.getitem(n),t);if(scheme_false(r)){return false}}return r}function do_or_form(e,t){for(var n=0;n<e.length;n++){var r=scheme_eval(e.getitem(n),t);if(scheme_true(r)){return r}}return false}function do_cond_form(e,t){var n=e.length;for(var r=0;r<e.length;r++){var i=e.getitem(r);check_form(i,1);if(i.first==="else"){if(r<n-1){throw"SchemeError: else must be last"}var s=true;if(i.second===nil){throw"SchemeError: badly formed else clause"}}else{s=scheme_eval(i.first,t)}if(scheme_true(s)){if(i.second.length==0){return s}return new Pair("begin",i.second)}}return null}function do_begin_form(e,t){check_form(e,1);var n=e.length-1;for(var r=0;r<n;r++){scheme_eval(e.getitem(r),t)}return e.getitem(n)}function create_global_frame(){var e=new Frame(null);e.define("eval",new PrimitiveProcedure(scheme_eval,true));e.define("apply",new PrimitiveProcedure(scheme_apply,true));add_primitives(e);return e}function add_primitives(e){for(var t in _PRIMITIVES){e.define(t,_PRIMITIVES[t])}}function check_form(e,t,n){if(!scheme_listp(e)){throw"SchemeError: badly formed expression: "+e.toString()}var r=e.length;if(r<t){throw"SchemeError: too few operands in form, expr="+e.toString()}else if(!(n===undefined)&&r>n){throw"SchemeError: too many operands in form: "+e.toString()}}function check_formals(e){var t;var n=[];if(scheme_symbolp(e)){return true}if(!scheme_listp(e)){var r=e.seperate_dotted();e=r[0];t=r[1]}check_form(e,0);for(var i=0;i<e.length;i++){var s=e.getitem(i);check_symbol(s,n);n.push(s)}if(t!==undefined){check_symbol(t,n);return true}else{return false}}function check_symbol(e,t){if(!scheme_symbolp(e)){throw"SchemeError: not a symbol: "+e.toString()}if(t.inside(e)){throw"SchemeError: repeated symbol in formal parameters: "+e}}function PrimitiveProcedure(e,t){if(typeof t==="undefined"){t=false}this.fn=e;this.use_env=t}function check_type(e,t,n,r){if(!t(e)){throw"SchemeError: argument "+n+" of "+r+" has wrong type ("+typeof e+")"}return e}function scheme_booleanp(e){return e===true||e===false}function scheme_true(e){return!(e===false)}function scheme_false(e){return e===false}function scheme_not(e){return!scheme_true(e)}function scheme_eqp(e,t){if(scheme_stringp(e)&&scheme_stringp(t)){return e.toString()===t.toString()}return e==t}function scheme_equalp(e,t){return e.toString()===t.toString()}function scheme_pairp(e){return e instanceof Pair}function scheme_nullp(e){return e===nil}function scheme_listp(e){while(e!==nil){if(!(e instanceof Pair)){return false}e=e.second}return true}function scheme_length(e){check_type(e,scheme_listp,0,"length");return e.length}function scheme_cons(e,t){return new Pair(e,t)}function scheme_car(e){check_type(e,scheme_pairp,0,"car");return e.first}function scheme_cdr(e){check_type(e,scheme_pairp,0,"cdr");return e.second}function scheme_cadr(e){return scheme_car(scheme_cdr(e))}function scheme_caddr(e){return scheme_car(scheme_cdr(scheme_cdr(e)))}function scheme_list(){var e=nil;for(var t=arguments.length-1;t>=0;t--){e=new Pair(arguments[t],e)}return e}function scheme_append(){if(arguments.length==0){return nil}var e=arguments[arguments.length-1];for(var t=arguments.length-2;t>=0;t--){var n=arguments[t];if(n!==nil){check_type(n,scheme_pairp,t,"append");var r=new Pair(n.first,e);var i=r;var n=n.second;while(scheme_pairp(n)){i.second=new Pair(n.first,e);i=i.second;n=n.second}e=r}}return e}function scheme_symbolp(e){return typeof e==="string"}function scheme_stringp(e){return e instanceof SchemeString}function scheme_numberp(e){return typeof e==="number"}function scheme_integerp(e){return typeof e==="number"&&Math.floor(e)===e}function _check_nums(e){for(var t=0;t<e.length;t++){if(!scheme_numberp(e[t])){throw"SchemeError: operand '"+e[t]+"' is not a number"}}}function _arith(e,t,n){_check_nums(n);var r=t;for(var i=0;i<n.length;i++){r=e(r,n[i])}if(Math.round(r)===r){r=Math.round(r)}return r}function scheme_add(){return _arith(function(e,t){return e+t},0,arguments)}function scheme_sub(){var e=Array.prototype.slice.call(arguments);if(e.length<1){throw"SchemeError: too few args"}else if(e.length==1){_check_nums([e[0]]);return-e[0]}else{return _arith(function(e,t){return e-t},e[0],e.slice(1))}}function scheme_mul(){return _arith(function(e,t){return e*t},1,arguments)}function scheme_div(e,t){if(t===0){throw"SchemeError: division by zero"}return _arith(function(e,t){return e/t},e,[t])}function scheme_quotient(e,t){var n=e/t;return Math[n>0?"floor":"ceil"](n)}function scheme_random(e){return Math.floor(Math.random()*e)}function scheme_remainder(e,t){return e%t}function scheme_modulo(e,t){return(e%t+t)%t}function scheme_floor(e){_check_nums([e]);return Math.floor(e)}function scheme_ceil(e){_check_nums([e]);return Math.ceil(e)}function scheme_eq(e,t){_check_nums([e,t]);return e===t}function scheme_lt(e,t){_check_nums([e,t]);return e<t}function scheme_gt(e,t){_check_nums([e,t]);return e>t}function scheme_le(e,t){_check_nums([e,t]);return e<=t}function scheme_ge(e,t){_check_nums([e,t]);return e>=t}function scheme_evenp(e){_check_nums([e]);return e%2===0}function scheme_oddp(e){_check_nums([e]);return e%2===1}function scheme_zerop(e){_check_nums([e]);return e===0}function scheme_atomp(e){return scheme_booleanp(e)||scheme_numberp(e)||scheme_symbolp(e)||scheme_nullp(e)||scheme_stringp(e)}function _check_strings(e){var t;for(var n=0;n<e.length;n++){t=e[n];if(!scheme_stringp(t)){throw"SchemeError: "+t+" is not a string"}}}function scheme_string_append(){_check_strings(arguments);var e="";for(var t=0;t<arguments.length;t++){e+=arguments[t].toString()}return e}function scheme_string_ref(e,t){_check_strings([e]);_check_nums([t]);return e.getchar(t)}function scheme_string_length(e){_check_strings([e]);return e.length}function scheme_substring(e,t,n){_check_strings([e]);_check_nums([t,n]);return e.substring(t,n)}function scheme_display(e){this.postMessage({type:"displayed_text",value:e.toString()})}function scheme_print(e){this.postMessage({type:"displayed_text",value:e.toString()+"\n"})}function scheme_newline(){this.postMessage({type:"displayed_text",value:"\n"})}function scheme_error(e){if(e===undefined){throw"SchemeError"}else{throw"SchemeError: "+e}}function runtime(){return(new Date).getTime()}function scheme_exit(){throw"EOFError"}importScripts("reader.js","tokenizer.js");onmessage=function(e){var t=create_global_frame();var n=new Buffer(tokenize_lines(e.data.split("\n")));while(n.current()!=null){try{var r=scheme_eval(scheme_read(n),t);if(!(r===null||r===undefined)){this.postMessage({type:"return_value",value:r.toString()})}}catch(i){this.postMessage({type:"error",value:i.toString()})}}this.postMessage({type:"end"})};Frame.prototype={lookup:function(e){if(e in this.bindings){return this.bindings[e]}else if(this.parent!==null){return this.parent.lookup(e)}else{throw"SchemeError: unknown identifier: "+e.toString()}},global_frame:function(){var e=this;while(e.parent!==null){e=e.parent}return e},make_call_frame:function(e,t,n){var r=new Frame(this);t=pair_to_array(t);if(n){var i,s;if(scheme_symbolp(e)){i=nil;s=e}else{var o=e.seperate_dotted();i=o[0];s=o[1]}var u=i.length;var a=array_to_pair(t.slice(u));e=scheme_append(i,new Pair(s,nil));t=t.slice(0,u);t.push(a)}e=pair_to_array(e);if(e.length!=t.length){throw"SchemeError: Invalid number of arguments"}for(var f=0;f<e.length;f++){r.bindings[e[f]]=t[f]}return r},define:function(e,t){this.bindings[e]=t},sete:function(e,t){if(e in this.bindings){this.bindings[e]=t}else if(this.parent!==null){this.parent.sete(e,t)}else{throw"SchemeError: "+e.toString()+" not found!"}}};LambdaProcedure.prototype={toString:function(){return"(lambda "+this.formals.toString()+" "+this.body.toString()+")"}};var LOGIC_FORMS={and:do_and_form,or:do_or_form,"if":do_if_form,cond:do_cond_form,begin:do_begin_form};var _PRIMITIVES={};_PRIMITIVES["boolean?"]=new PrimitiveProcedure(scheme_booleanp);_PRIMITIVES["not"]=new PrimitiveProcedure(scheme_not);_PRIMITIVES["eq?"]=new PrimitiveProcedure(scheme_eqp);_PRIMITIVES["equal?"]=new PrimitiveProcedure(scheme_equalp);_PRIMITIVES["pair?"]=new PrimitiveProcedure(scheme_pairp);_PRIMITIVES["null?"]=new PrimitiveProcedure(scheme_nullp);_PRIMITIVES["list?"]=new PrimitiveProcedure(scheme_listp);_PRIMITIVES["length"]=new PrimitiveProcedure(scheme_length);_PRIMITIVES["cons"]=new PrimitiveProcedure(scheme_cons);_PRIMITIVES["car"]=new PrimitiveProcedure(scheme_car);_PRIMITIVES["cdr"]=new PrimitiveProcedure(scheme_cdr);_PRIMITIVES["cadr"]=new PrimitiveProcedure(scheme_cadr);_PRIMITIVES["caddr"]=new PrimitiveProcedure(scheme_caddr);_PRIMITIVES["list"]=new PrimitiveProcedure(scheme_list);_PRIMITIVES["append"]=new PrimitiveProcedure(scheme_append);_PRIMITIVES["symbol?"]=new PrimitiveProcedure(scheme_symbolp);_PRIMITIVES["string?"]=new PrimitiveProcedure(scheme_stringp);_PRIMITIVES["number?"]=new PrimitiveProcedure(scheme_numberp);_PRIMITIVES["integer?"]=new PrimitiveProcedure(scheme_integerp);_PRIMITIVES["+"]=new PrimitiveProcedure(scheme_add);_PRIMITIVES["-"]=new PrimitiveProcedure(scheme_sub);_PRIMITIVES["*"]=new PrimitiveProcedure(scheme_mul);_PRIMITIVES["/"]=new PrimitiveProcedure(scheme_div);_PRIMITIVES["quotient"]=new PrimitiveProcedure(scheme_quotient);_PRIMITIVES["random"]=new PrimitiveProcedure(scheme_random);_PRIMITIVES["abs"]=new PrimitiveProcedure(Math.abs);_PRIMITIVES["log"]=new PrimitiveProcedure(Math.log);_PRIMITIVES["exp"]=new PrimitiveProcedure(Math.exp);_PRIMITIVES["expt"]=new PrimitiveProcedure(Math.pow);_PRIMITIVES["sin"]=new PrimitiveProcedure(Math.sin);_PRIMITIVES["cos"]=new PrimitiveProcedure(Math.cos);_PRIMITIVES["tan"]=new PrimitiveProcedure(Math.tan);_PRIMITIVES["asin"]=new PrimitiveProcedure(Math.asin);_PRIMITIVES["acos"]=new PrimitiveProcedure(Math.acos);_PRIMITIVES["atan"]=new PrimitiveProcedure(Math.atan);_PRIMITIVES["remainder"]=new PrimitiveProcedure(scheme_remainder);_PRIMITIVES["modulo"]=new PrimitiveProcedure(scheme_modulo);_PRIMITIVES["floor"]=new PrimitiveProcedure(scheme_floor);_PRIMITIVES["ceil"]=new PrimitiveProcedure(scheme_ceil);_PRIMITIVES["="]=new PrimitiveProcedure(scheme_eq);_PRIMITIVES["<"]=new PrimitiveProcedure(scheme_lt);_PRIMITIVES[">"]=new PrimitiveProcedure(scheme_gt);_PRIMITIVES["<="]=new PrimitiveProcedure(scheme_le);_PRIMITIVES[">="]=new PrimitiveProcedure(scheme_ge);_PRIMITIVES["even?"]=new PrimitiveProcedure(scheme_evenp);_PRIMITIVES["odd?"]=new PrimitiveProcedure(scheme_oddp);_PRIMITIVES["zero?"]=new PrimitiveProcedure(scheme_zerop);_PRIMITIVES["atom?"]=new PrimitiveProcedure(scheme_atomp);_PRIMITIVES["string-append"]=new PrimitiveProcedure(scheme_string_append);_PRIMITIVES["string-ref"]=new PrimitiveProcedure(scheme_string_ref);_PRIMITIVES["string-length"]=new PrimitiveProcedure(scheme_string_length);_PRIMITIVES["substring"]=new PrimitiveProcedure(scheme_substring);_PRIMITIVES["display"]=new PrimitiveProcedure(scheme_display);_PRIMITIVES["print"]=new PrimitiveProcedure(scheme_print);_PRIMITIVES["newline"]=new PrimitiveProcedure(scheme_newline);_PRIMITIVES["error"]=new PrimitiveProcedure(scheme_error);_PRIMITIVES["runtime"]=new PrimitiveProcedure(runtime);_PRIMITIVES["exit"]=new PrimitiveProcedure(scheme_exit)
